{% extends "base.html" %}

{% block title %}Dashboard - Narissa Realty CRM{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Main Dashboard Content -->
        <div class="col-lg-9">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center border-bottom mb-4">
                <h1 class="h2">Dashboard</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-calendar3"></i> This week
                        </button>
                    </div>
                    <button type="button" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus"></i> Quick Add
                    </button>
                </div>
            </div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Clients</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.total_clients }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-people fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Active Transactions</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.active_transactions }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-clipboard-data fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Properties</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.properties }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-house fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">This Month Closings</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.this_month_closings }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-trophy fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-2">
                        <a href="{{ url_for('new_client') }}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-person-plus"></i> Add Client
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-2">
                        <a href="{{ url_for('new_property') }}" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-house-add"></i> Add Property
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-2">
                        <a href="{{ url_for('new_transaction') }}" class="btn btn-outline-success w-100">
                            <i class="bi bi-clipboard-plus"></i> New Transaction
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-2">
                        <button class="btn btn-outline-info w-100" onclick="generateForms()">
                            <i class="bi bi-file-earmark-pdf"></i> Generate Forms
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Recent Transactions</h5>
                <a href="{{ url_for('transactions_list') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                {% if recent_transactions %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Property</th>
                                <th>Buyer</th>
                                <th>Seller</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Offer Date</th>
                                <th>Close Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in recent_transactions %}
                            <tr>
                                <td>
                                    <strong>{{ transaction.address_street }}</strong><br>
                                    <small class="text-muted">{{ transaction.address_city }}</small>
                                </td>
                                <td>
                                    {% if transaction.buyer_first %}
                                        {{ transaction.buyer_first }} {{ transaction.buyer_last }}
                                    {% else %}
                                        <span class="text-muted">TBD</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if transaction.seller_first %}
                                        {{ transaction.seller_first }} {{ transaction.seller_last }}
                                    {% else %}
                                        <span class="text-muted">TBD</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if transaction.purchase_price %}
                                        <span class="currency">${{ "{:,.0f}".format(transaction.purchase_price) }}</span>
                                    {% else %}
                                        <span class="text-muted">TBD</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge status-badge 
                                        {% if transaction.status == 'pending' %}bg-warning
                                        {% elif transaction.status == 'under_contract' %}bg-info
                                        {% elif transaction.status == 'closed' %}bg-success
                                        {% elif transaction.status == 'cancelled' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {{ transaction.status.replace('_', ' ').title() }}
                                    </span>
                                </td>
                                <td>
                                    {% if transaction.offer_date %}
                                        {{ transaction.offer_date }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if transaction.close_of_escrow_date %}
                                        {{ transaction.close_of_escrow_date }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary btn-sm" onclick="generateTransactionForms({{ transaction.id }})">
                                            <i class="bi bi-file-earmark-pdf"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-clipboard-data text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-2">No transactions yet</h5>
                    <p class="text-muted">Create your first transaction to get started</p>
                    <a href="{{ url_for('new_transaction') }}" class="btn btn-primary">Create Transaction</a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- AI Chatbot Sidebar -->
        <div class="col-lg-3">
            <div class="chatbot-sidebar">
                <!-- AI Status -->
                <div class="mb-3">
                    <h6>
                        <span class="status-indicator status-ready" id="aiStatus"></span>
                        AI Assistant
                    </h6>
                    <small class="text-muted" id="aiStatusText">Ready for processing</small>
                </div>
                
                <!-- Chat Container -->
                <div class="chat-container-mini">
                    <div class="chat-messages-mini" id="chatMessages">
                        <div class="message ai">
                            <strong>AI:</strong> Ready to help! Paste emails or ask questions.
                        </div>
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="chat-input-mini">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="chatInput" 
                                   placeholder="Ask me anything...">
                            <button class="btn btn-primary" type="button" id="sendButton">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Email Paste Area -->
                <div class="email-paste-area mt-3" id="emailPasteArea">
                    <div class="text-center mb-2">
                        <i class="bi bi-envelope-plus" style="font-size: 1.5rem; color: #2c5aa0;"></i>
                        <h6 class="mt-1">Email Processor</h6>
                        <small class="text-muted">Paste email content for extraction</small>
                    </div>
                    
                    <textarea id="emailContent" 
                              placeholder="Paste email content here..."
                              class="form-control" rows="4"></textarea>
                    
                    <div class="mt-2 d-grid gap-1">
                        <button class="btn btn-primary btn-sm" id="processEmailBtn">
                            <i class="bi bi-cpu"></i> Process Email
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="clearEmailBtn">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                    </div>
                </div>
                
                <!-- Processing Indicator -->
                <div class="processing-indicator" id="processingIndicator" style="display: none;">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <p class="mt-2 mb-0 small">Analyzing content...</p>
                    </div>
                </div>
                
                <!-- Extraction Results -->
                <div class="extraction-results" id="extractionResults" style="display: none;">
                    <h6 class="small">Extracted Data</h6>
                    <div id="extractedEntities"></div>
                    <div class="mt-2 d-grid gap-1">
                        <button class="btn btn-success btn-sm" id="addToCrmBtn">
                            <i class="bi bi-database-add"></i> Add to CRM
                        </button>
                        <button class="btn btn-outline-primary btn-sm" id="previewDataBtn">
                            <i class="bi bi-eye"></i> Preview
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Existing dashboard functions
function generateForms() {
    alert('Form generation feature coming soon!');
}

function generateTransactionForms(transactionId) {
    if (confirm('Generate PDF forms for this transaction?')) {
        fetch(`/api/generate_forms/${transactionId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Forms generation initiated! Check the generated_offers folder.');
                }
            })
            .catch(error => {
                alert('Error generating forms: ' + error);
            });
    }
}

// Chatbot Integration JavaScript
document.addEventListener('DOMContentLoaded', function() {
    initializeChatbot();
});

// Global chatbot variables
let chatHistory = [];
let extractedData = null;
let aiReady = false;

// Initialize chatbot functionality
function initializeChatbot() {
    setupChatbotEventListeners();
    updateAIStatus('ready', 'Ready for processing');
    aiReady = true;
}

// Setup chatbot event listeners
function setupChatbotEventListeners() {
    // Chat input
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
    }
    
    if (sendButton) {
        sendButton.addEventListener('click', sendChatMessage);
    }
    
    // Email processing
    const processEmailBtn = document.getElementById('processEmailBtn');
    const clearEmailBtn = document.getElementById('clearEmailBtn');
    const addToCrmBtn = document.getElementById('addToCrmBtn');
    const previewDataBtn = document.getElementById('previewDataBtn');
    
    if (processEmailBtn) {
        processEmailBtn.addEventListener('click', processEmail);
    }
    
    if (clearEmailBtn) {
        clearEmailBtn.addEventListener('click', clearEmail);
    }
    
    if (addToCrmBtn) {
        addToCrmBtn.addEventListener('click', addToCRM);
    }
    
    if (previewDataBtn) {
        previewDataBtn.addEventListener('click', previewData);
    }
    
    // Email paste area interactions
    const emailPasteArea = document.getElementById('emailPasteArea');
    const emailContent = document.getElementById('emailContent');
    
    if (emailContent && emailPasteArea) {
        emailContent.addEventListener('focus', () => {
            emailPasteArea.classList.add('active');
        });
        
        emailContent.addEventListener('blur', () => {
            emailPasteArea.classList.remove('active');
        });
        
        emailContent.addEventListener('paste', () => {
            setTimeout(() => {
                if (emailContent.value.trim()) {
                    addAIMessage('Email content detected. Click "Process Email" to extract data automatically.');
                }
            }, 100);
        });
    }
}

// Update AI status indicator
function updateAIStatus(status, text) {
    const statusIndicator = document.getElementById('aiStatus');
    const statusText = document.getElementById('aiStatusText');
    
    if (statusIndicator) {
        statusIndicator.className = `status-indicator status-${status}`;
    }
    
    if (statusText) {
        statusText.textContent = text;
    }
}

// Send chat message
function sendChatMessage() {
    const input = document.getElementById('chatInput');
    if (!input) return;
    
    const message = input.value.trim();
    
    if (message) {
        addUserMessage(message);
        input.value = '';
        
        // Send to backend chat endpoint
        if (aiReady) {
            updateAIStatus('processing', 'Thinking...');
            
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    message: message,
                    conversation_history: chatHistory.slice(-5),  // Send last 5 messages for context
                    context: 'Dashboard sidebar interaction'
                })
            })
            .then(response => response.json())
            .then(data => {
                updateAIStatus('ready', 'Ready for processing');
                
                if (data.response) {
                    addAIMessage(data.response);
                    
                    // Display function suggestions if available
                    if (data.suggested_functions && data.suggested_functions.length > 0) {
                        let suggestions = '\n\n💡 Suggestions:\n';
                        data.suggested_functions.forEach(func => {
                            suggestions += `• ${func.function}: ${func.reason}\n`;
                        });
                        addAIMessage(suggestions);
                    }
                } else {
                    addAIMessage('Sorry, I encountered an error processing your message.');
                }
            })
            .catch(error => {
                console.error('Chat error:', error);
                updateAIStatus('error', 'Connection failed');
                addAIMessage('Connection error. Please check that the Flask server is running and try again.');
            });
        } else {
            // Fallback for when backend is not ready
            setTimeout(() => {
                addAIMessage('I received your message: "' + message + '". Backend integration in progress.');
            }, 500);
        }
    }
}

// Add user message to chat
function addUserMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message user';
    messageDiv.innerHTML = '<strong>You:</strong> ' + escapeHtml(message);
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    chatHistory.push({ type: 'user', message: message });
}

// Add AI message to chat
function addAIMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ai';
    messageDiv.innerHTML = '<strong>AI:</strong> ' + escapeHtml(message);
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    chatHistory.push({ type: 'ai', message: message });
}

// Process email content
function processEmail() {
    const emailContent = document.getElementById('emailContent');
    const processingIndicator = document.getElementById('processingIndicator');
    const extractionResults = document.getElementById('extractionResults');
    
    if (!emailContent || !emailContent.value.trim()) {
        addAIMessage('Please paste email content first.');
        return;
    }
    
    const content = emailContent.value.trim();
    
    // Show processing indicator
    if (processingIndicator) {
        processingIndicator.style.display = 'block';
    }
    
    if (extractionResults) {
        extractionResults.style.display = 'none';
    }
    
    updateAIStatus('processing', 'Processing email content...');
    
    // Send to backend processing endpoint
    fetch('/process_email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email_content: content })
    })
    .then(response => response.json())
    .then(data => {
        // Hide processing indicator
        if (processingIndicator) {
            processingIndicator.style.display = 'none';
        }
        
        if (data.extracted_data) {
            extractedData = data.extracted_data;
            displayExtractionResults(data.extracted_data);
            updateAIStatus('ready', 'Data extracted successfully');
            
            if (data.message) {
                addAIMessage(data.message);
            } else {
                addAIMessage('Email processed successfully! Found ' + Object.keys(data.extracted_data).length + ' data fields.');
            }
        } else if (data.message) {
            updateAIStatus('ready', 'Processing complete');
            addAIMessage(data.message);
            
            // For now, show basic extraction for demo
            extractedData = { status: 'processed', content_length: content.length };
            displayExtractionResults(extractedData);
        } else {
            updateAIStatus('error', 'Processing failed');
            addAIMessage('Failed to extract data from email. Please check the content and try again.');
        }
    })
    .catch(error => {
        console.error('Processing error:', error);
        
        // Hide processing indicator
        if (processingIndicator) {
            processingIndicator.style.display = 'none';
        }
        
        // Fallback processing for demo purposes
        simulateEmailProcessing(content);
    });
}

// Simulate email processing (fallback when backend not ready)
function simulateEmailProcessing(content) {
    updateAIStatus('processing', 'Processing with demo AI...');
    
    setTimeout(() => {
        // Simple regex-based extraction for demo
        const phoneRegex = /(\d{3}[-.]?\d{3}[-.]?\d{4})/g;
        const emailRegex = /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g;
        const nameRegex = /(?:my name is|i'm|i am)\s+([a-zA-Z\s]+)/gi;
        
        const demoData = {};
        
        const phones = content.match(phoneRegex);
        if (phones) demoData.phone = phones[0];
        
        const emails = content.match(emailRegex);
        if (emails) demoData.email = emails[0];
        
        const names = nameRegex.exec(content);
        if (names) demoData.name = names[1].trim();
        
        if (Object.keys(demoData).length > 0) {
            extractedData = demoData;
            displayExtractionResults(demoData);
            updateAIStatus('ready', 'Demo extraction complete');
            addAIMessage('Demo processing complete! Found ' + Object.keys(demoData).length + ' data fields.');
        } else {
            updateAIStatus('ready', 'No data extracted');
            addAIMessage('No recognizable data patterns found in the email content.');
        }
    }, 2000);
}

// Display extraction results
function displayExtractionResults(data) {
    const extractionResults = document.getElementById('extractionResults');
    const extractedEntities = document.getElementById('extractedEntities');
    
    if (!extractionResults || !extractedEntities) return;
    
    let html = '';
    for (const [key, value] of Object.entries(data)) {
        html += `<div class="mb-1"><small><strong>${key}:</strong> ${escapeHtml(value)}</small></div>`;
    }
    
    extractedEntities.innerHTML = html;
    extractionResults.style.display = 'block';
}

// Clear email content
function clearEmail() {
    const emailContent = document.getElementById('emailContent');
    const extractionResults = document.getElementById('extractionResults');
    const processingIndicator = document.getElementById('processingIndicator');
    
    if (emailContent) {
        emailContent.value = '';
    }
    
    if (extractionResults) {
        extractionResults.style.display = 'none';
    }
    
    if (processingIndicator) {
        processingIndicator.style.display = 'none';
    }
    
    extractedData = null;
    updateAIStatus('ready', 'Ready for processing');
}

// Add to CRM
function addToCRM() {
    if (!extractedData) {
        addAIMessage('No extracted data available. Please process an email first.');
        return;
    }
    
    addAIMessage('Adding extracted data to CRM database...');
    
    // Here would be the actual CRM integration
    // For now, show success message
    setTimeout(() => {
        addAIMessage('Data successfully added to CRM! Dashboard will update automatically.');
        
        // Optionally refresh dashboard data
        if (typeof refreshDashboardData === 'function') {
            refreshDashboardData();
        }
        
        clearEmail();
    }, 1500);
}

// Preview data
function previewData() {
    if (!extractedData) {
        addAIMessage('No extracted data available. Please process an email first.');
        return;
    }
    
    let previewText = 'Extracted Data Preview:\n\n';
    for (const [key, value] of Object.entries(extractedData)) {
        previewText += `${key}: ${value}\n`;
    }
    
    alert(previewText);
}

// Utility function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Auto-refresh dashboard every 5 minutes (disabled during active chat)
let refreshInterval = setInterval(function() {
    if (chatHistory.length === 0) {
        window.location.reload();
    }
}, 300000);
</script>
{% endblock %}